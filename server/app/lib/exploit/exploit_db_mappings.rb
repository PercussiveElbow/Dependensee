require 'net/http'
require 'zip'
require 'fileutils'

class ExploitDbMappings

  EXPLOIT_MAPPING_SITE = 'cve.mitre.org'
  EXPLOIT_MAPPING_SITE_LOC = '/data/refs/refmap/allrefmaps.zip'
  EXPLOIT_MAPPING_DOWNLOAD_LOC = '/tmp/dependensee/mapping.zip'
  EXPLOIT_MAPPING_UNZIP_LOC = '/tmp/dependensee/mappings/'

  def initialize(location)

    print "Beginning download of ExploitDB mappings\n"

    Net::HTTP.start(EXPLOIT_MAPPING_SITE) do |http|
      resp = http.get(EXPLOIT_MAPPING_SITE_LOC)

      open(EXPLOIT_MAPPING_DOWNLOAD_LOC, "w+") do |file|
        file.write(resp.body)
      end
    end

    puts "Done download of ExploitDB mappings Beginning extract...\n"


    FileUtils.rm_rf EXPLOIT_MAPPING_UNZIP_LOC
    FileUtils.mkdir_p EXPLOIT_MAPPING_UNZIP_LOC

    Zip::File.open(EXPLOIT_MAPPING_DOWNLOAD_LOC) do |zip_file|
      # Handle entries one by one
      zip_file.each do |entry|
        # Extract to file/directory/symlink
        puts "Extracting #{entry.name}"

        entry.extract(EXPLOIT_MAPPING_UNZIP_LOC +entry.name)
      end
    end




  end
end

ExploitDbMappings::new('')