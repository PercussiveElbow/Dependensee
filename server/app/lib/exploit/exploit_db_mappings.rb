require 'net/http'
require 'zip'
require 'fileutils'
require 'nokogiri'
require_relative '../../models/exploit'
require_relative '../msg_constants'

class ExploitDbMappings

  def initialize
    print "Beginning download of ExploitDB mappings\n"
    Net::HTTP.start(MsgConstants::EXPLOIT_MAPPING_SITE) do |http|
      resp = http.get(MsgConstants::EXPLOIT_MAPPING_SITE_LOC)
      open(MsgConstants::EXPLOIT_MAPPING_DOWNLOAD_LOC, "w+") do |file|
        file.write(resp.body.encode("ASCII-8BIT").force_encoding("utf-8"))
      end
    end
    FileUtils.rm_rf MsgConstants::EXPLOIT_MAPPING_UNZIP_LOC
    FileUtils.mkdir_p MsgConstants::EXPLOIT_MAPPING_UNZIP_LOC

    Zip::File.open(MsgConstants::EXPLOIT_MAPPING_DOWNLOAD_LOC) do |zip_file|
      zip_file.each do |entry|
        entry.extract('/tmp/dependensee/mappings/' +entry.name)
      end
    end
    # Exploit.delete_all
    doc = Nokogiri::HTML(File.read(MsgConstants::EXPLOIT_MAPPING_UNZIP_LOC+MsgConstants::EXPLOIT_MAPPING_FILE_NAME))
    rows = doc.xpath('//table/tr')
    count = 0
    details = rows.collect do |row|
      detail = {}
      [[:id, 'td[1]/text()'], [:cves, 'td[2]/descendant::*/text()']].each do |name, xpath| #todo fix bug where this only grabs first cve
        detail[name] = row.at_xpath(xpath).to_s.strip
      end
      detail[:id] = detail[:id].gsub(/[^0-9,.]/, "")
      detail[:cves] = detail[:cves].gsub('CVE-', '')
      count += 1
      Exploit::new(:edb_id => detail[:id], :cves => [detail[:cves]]).save! if Exploit.where(" '#{detail[:cves]}' = ANY (cves)").empty? if count > 3
    end
  end

end