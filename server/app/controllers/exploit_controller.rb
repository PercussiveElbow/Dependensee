require_relative '../lib/msg_constants'

class ExploitController < ApplicationController
  before_action :find_exploit_by_cve, only: [:show]
  skip_before_action :auth_req
  # Exploit Controller, no auth required

  api :GET, '/exploit/:cve_id/', 'Get an Exploit'
  param :id, String, :desc => 'CVE ID ', :required=>true
  def show
    if !request.headers['download'].nil? and request.headers['download'] == 'no'
      json_response({})
    else
      send_file(@exploit, :filename => 'exploit'+File.extname(@exploit) , :type => MsgConstants::MIME_TEXT)
    end
  end

  private
  def find_exploit_by_cve
    begin
      param! :id, String, required: true, format:  /^\d{4}-(0\d{3}|[1-9]\d{3,})$/
    rescue
      raise CustomException::ValidationError, MsgConstants::VALIDATION_ERROR
    end
    exploits = Exploit.where(" '#{params[:id]}' = ANY (cves)")
    if exploits.nil? or exploits.empty?
      raise CustomException::NotFound, MsgConstants::NOT_FOUND
    end
    exploit_id = exploits.first.edb_id.to_s
    @exploit = $exploit_db.get_exploit_by_id(exploit_id)
  end

end
