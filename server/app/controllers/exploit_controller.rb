require_relative '../lib/msg_constants'

class ExploitController < ApplicationController
  before_action :cve_or_edb, only: [:show]
  skip_before_action :auth_req

  api :GET, '/exploit/:cve_id/', 'Exploit Get'
  param :id, String, :required=>true
  def show
    if !request.headers['download'].nil? and request.headers['download'] == 'no'
      json_response({})
    else
      send_file(@exploit, :filename => 'exploit'+File.extname(@exploit) , :type => "application/txt")
    end
  end

  def cve_or_edb
    # params[:id].include? "-" ? find_exploit_by_cve : find_cve_by_edb_id
    find_exploit_by_cve
  end

  def find_exploit_by_cve
    begin
      param! :id, String, required: true, format:  /^\d{4}-(0\d{3}|[1-9]\d{3,})$/
    rescue
      raise CustomException::ValidationError, MsgConstants::VALIDATION_ERROR
    end
    exploits = Exploit.where(" '#{params[:id]}' = ANY (cves)")
    if exploits.nil? or exploits.empty?
      raise CustomException::NotFound, MsgConstants::NOT_FOUND
    end
    exploit_id = exploits.first.edb_id.to_s
    @exploit = $exploit_db.get_exploit_by_id(exploit_id)
  end

  # def find_cve_by_edb_id
  #   exploit_id = Exploit.where(['edb_id = ?', params[:id]]).first.edb_id.to_s
  #   @exploit = ExploitDB.get_exploit_by_id(exploit_id);
  # end

end
