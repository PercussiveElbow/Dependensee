<template>
  <div id ='something'>
    <div class="app-viewport" id="file-list">
    <Sidebar ref='sidebar'></Sidebar>
  
  <md-whiteframe md-elevation="3" class="main-toolbar">
    <md-toolbar class="md-large">
      <div class="md-toolbar-container">
        <md-button class="md-icon-button" @click="$refs.sidebar.toggleSidebar()">
          <md-icon>menu</md-icon>
        </md-button>
  
        <span style="flex: 1"></span>
  
        <md-button class="md-icon-button">
          <md-icon>search</md-icon>
        </md-button>
  
        <md-button class="md-icon-button">
          <md-icon>view_module</md-icon>
        </md-button>
      </div>


      <div class="md-toolbar-container">
          <md-button class="md-icon-button"  @click="$router.push({ path: '/projects/' });">
          <md-icon>home</md-icon>
        </md-button>
        <h2 class="md-title">Project: {{project.name}}</h2>
          <md-button @click=show class="md-fab md-mini">
          <md-icon>file_upload</md-icon>
        </md-button>
      </div>
    </md-toolbar>

  </md-whiteframe>

        <md-tabs>
      <md-tab id="tab-scans" md-label="Scans" to="/components/tabs/scans">


      <main class="main-content">

        <div>
      <md-list class="md-double-line">
        <md-list-item v-for="scan in scans">

          <md-avatar class="md-avatar-icon md-primary" md-theme="red" v-if="project.language === 'Ruby'" >
            <md-icon >assessment</md-icon>
          </md-avatar>
          <md-avatar class="md-avatar-icon md-primary" md-theme="orange" v-if="project.language === 'Java'" >
            <md-icon >assessment</md-icon>
          </md-avatar>
                <md-avatar class="md-avatar-icon md-primary" md-theme="green" v-if="project.language === 'Python'" >
            <md-icon >assessment</md-icon>
          </md-avatar>
          <div class="md-list-text-container">
            <router-link :to="{ path: '/scan/' + project.id+'/'+scan.id }">Scan: {{scan.title}}</router-link>
            <p>{{ scan.id }}</p>
<!--             <p>{{ scan.description }}</p>
 -->          </div>

          <md-button class="md-icon-button md-list-action"  @click=delete_scan(scan.id)>
            <md-icon>delete</md-icon>
          </md-button>
          <md-button class="md-icon-button md-list-action"  @click=view_vulns(scan.id)>
            <md-icon>file_download</md-icon>
          </md-button>

        </md-list-item>
      </md-list>
      <v-dialog/>

      </div>

      </main>
    </md-tab>

      <md-tab id="tab-history" md-label="History" to="/components/tabs/history">

  <vue-event-calendar :events="scansCalendar"></vue-event-calendar>


      </md-tab>
  </md-tabs>


</div>

<modal name="upload"         :height="350" :adaptive="true" @opened="opened">
    <div style="padding: 30px; text-align: center">
          <h2 v-if="project.language == 'Ruby' " >Upload Gemfile</h2>
          <h2 v-if="project.language  === 'Java' " >Upload Pomfile</h2>
          <h2 v-if="project.language  === 'Python' " >Upload Dependencies.txt</h2>

          <md-input-container>
              <md-icon>work</md-icon>
              <label>Text Input (DEBUG)</label>
              <md-input name v-model="upload.body"/>
            </md-input-container>


         <md-input-container>
        <md-file placeholder='Select a file' ></md-file>
      </md-input-container>
  <md-button class="md-primary md-raised" v-on:click=handle_upload>Scan</md-button>
    </div>
</modal>
  </div>

</template>

<script>

  import {getToken,getProject,getScans,upload,getJsonReport,deleteScan} from '../utils/api.js';
  import Sidebar from './Sidebar'

  export default {
    name: 'Project',
    components:  {
      Sidebar
    },
    data() {
      return {
        project: {

        },
        scans: [],
        scansCalendar: [],
        upload: {
          body : ''
        },
        report: {}
       }
    },
    created() {
      this.get_project();
      this.get_scans();
      setInterval(function () {this.get_scans();}.bind(this), 10000); 
    },
    watch: {
      '$route': 'fetchData'
    },
    methods: {
      get_project() {getProject(this.$route.params.id).then(response =>  {this.project = response;});},
      get_scans() {
          getScans(this.$route.params.id).then(response =>  {

          this.scans = response;
          this.scansCalendar = this.scans;

          this.scans.forEach(function (scan) {
            scan.title = scan.created_at.slice(0, scan.created_at.length-8).replace("T", "  ");
          });
          this.scansCalendar.forEach(function (scan) {
            scan.date = scan.created_at.slice(0, 10)
            scan.date = scan.date.replace(/-/g,"/");
            console.log(scan.date);
          });
      });
      },
      delete_scan(id) {
        deleteScan(this.$route.params.id,id)
        this.get_scans;
      },
      handle_upload(){upload(this.$route.params.id,this.upload.body);},
      show () {this.$modal.show('upload');},
      hide () {this.$modal.hide('upload');},
      view_vulns(scan_id) {getJsonReport(this.$route.params.id,scan_id).then(response =>  {this.open_vuln_dialog(response)})},
      open_vuln_dialog (response) {
        this.report=response;
          this.$modal.show('dialog', {
            title: 'Vulnerabilities',
            text: this.report,
            buttons: [
              { title: 'JSON', handler: () => { alert('pdf') } },
              { title: 'PDF' },
              { title: 'HTML'}
           ]
          })
      }
    }
  } 
</script>


<style scoped>
html,
body,
.app-viewport {
  height: 100%;
  overflow: hidden;
}

.app-viewport {
  display: flex;
  flex-flow: column;
}

.main-toolbar {
  position: relative;
  z-index: 10;
}

.md-fab {
  margin: 0;
  position: absolute;
  bottom: -20px;
  left: 16px;
  z-index: 10;
  
  .md-icon {
    color: #fff;
  }
}

.md-title {
  padding-left: 8px;
  color: #fff;
}

.main-content {
  position: relative;
  z-index: 1;
  overflow: auto;
}

.md-tab {
   background-color: white;
}
</style>
